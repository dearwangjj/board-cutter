<!-- æ·»åŠ åˆ° <head> ä¸­ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>äººé€ æ¿ç”²é†›æ‰¿è½½é™é‡è®¡ç®—å™¨</title>
<link rel="icon" href="data:,">
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>äººé€ æ¿ç”²é†›æ‰¿è½½é™é‡è®¡ç®—å™¨ - GB/T 39598-2021</title>
  <!-- jsPDF + html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
      background: #f8fafc;
      color: #333;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    h1 {
      text-align: center;
      color: #1a73e8;
      font-size: 22px;
      margin: 10px 0;
    }
    .btn-group {
      text-align: center;
      margin: 16px 0;
    }
    button {
      margin: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    .calc-btn { background: #1a73e8; color: white; }
    .compare-btn { background: #ff9800; color: white; }
    .pdf-btn { background: #d81b60; color: white; }
    .share-btn { background: #07c260; color: white; }
    .room {
      padding: 14px;
      margin: 14px 0;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f9fbfd;
    }
    input, select {
      padding: 6px 10px;
      margin: 4px 6px 4px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      width: 100px;
    }
    label {
      display: inline-block;
      width: 90px;
      font-size: 13px;
      color: #555;
      text-align: right;
      margin-right: 8px;
    }
    .result-box {
      padding: 14px;
      margin: 18px 0;
      border-radius: 10px;
      font-weight: bold;
      text-align: center;
      font-size: 16px;
    }
    .safe { background: #e6f4ea; color: #137333; }
    .unsafe { background: #fce8e6; color: #c62828; }
    .note {
      font-size: 12px;
      color: #888;
      margin-top: 10px;
      text-align: center;
    }
    .collapse {
      font-size: 13px;
      color: #1a73e8;
      margin-top: 12px;
      cursor: pointer;
      text-decoration: underline;
    }
    .export-area { display: none; }
    ul { padding-left: 20px; margin: 8px 0; }
    .projection-item {
      margin: 12px 0;
      padding: 12px;
      background: #f9fbfd;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="card">
  <h1>äººé€ æ¿ç”²é†›æ‰¿è½½é™é‡è®¡ç®—å™¨</h1>
  <p style="text-align:center;color:#666;">ä¾æ®å›½å®¶æ ‡å‡†ã€ŠGB/T 39598-2021ã€‹</p>

  <div class="btn-group">
    <button onclick="addRoom()">â• æ·»åŠ æˆ¿é—´</button>
    <button onclick="calculate()" class="calc-btn">ğŸ§® è®¡ç®—æœ€å¤§å®‰å…¨ç”¨é‡</button>
    <button onclick="showProjection()" class="compare-btn">ğŸ“ å¯¹æ¯”é”€å”®æŠ•å½±é¢ç§¯</button>
    <button onclick="exportToPDF()" class="pdf-btn">ğŸ“¥ å¯¼å‡ºPDFæŠ¥å‘Š</button>
    <button onclick="sharePage()" class="share-btn">â†—ï¸ å¾®ä¿¡åˆ†äº«</button>
  </div>

  <div id="rooms"></div>
  <div id="projectionSection" style="display:none;"></div>
  <div id="resultDisplay"></div> <!-- å§‹ç»ˆåªæ˜¾ç¤ºæœ€æ–°ç»“æœ -->

  <div class="note">
    æ³¨ï¼šæœ¬å·¥å…·ç”¨äºä¼°ç®—å®¤å†…äººé€ æ¿çš„æœ€å¤§å®‰å…¨ä½¿ç”¨é¢ç§¯ã€‚å®é™…è£…ä¿®è¯·ç»“åˆé€šé£ã€ææ–™å åŠ ç­‰å› ç´ ç»¼åˆè¯„ä¼°ã€‚
  </div>

  <div class="collapse" onclick="toggleComplexityHelp()">â„¹ï¸ ç»“æ„å¤æ‚åº¦ç³»æ•°è¯´æ˜ï¼ˆä¾›å‚è€ƒï¼‰</div>
  <div id="complexityHelp" style="display:none;margin-top:12px;font-size:13px;line-height:1.6;">
    <strong>ç»“æ„å¤æ‚åº¦å½±å“è¯´æ˜ï¼ˆGB/T 39598-2021 é™„å½•Aï¼‰ï¼š</strong><br>
    â€¢ ç®€å•ç»“æ„ï¼ˆå¦‚ä»…åœ°æ¿+å°‘é‡æŸœä½“ï¼‰ï¼šæ¢æ°”ç³»æ•° n å¯å– 0.5ï½1.0<br>
    â€¢ ä¸­ç­‰å¤æ‚ï¼ˆå…¨å±‹å®šåˆ¶+åŠé¡¶ï¼‰ï¼šå»ºè®® n = 0.5ï¼ˆä¿å®ˆè®¾è®¡ï¼‰<br>
    â€¢ é«˜åº¦å¤æ‚ï¼ˆå¯†é—­ç©ºé—´ã€å¤§é‡æ¿æé›†ä¸­ï¼‰ï¼šéœ€é™ä½ n å€¼æˆ–å¢åŠ é€šé£<br>
    â€¢ æœ¬å·¥å…·é»˜è®¤æŒ‰ n=0.5 è®¡ç®—ï¼Œç”¨æˆ·å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚
  </div>
</div>

<!-- éšè—åŒºåŸŸï¼šç”¨äºPDFå¯¼å‡º -->
<div id="fullReport" class="export-area">
  <h1 style="text-align:center;color:#1a73e8;">GB/T 39598-2021 ç”²é†›æ‰¿è½½é™é‡è®¡ç®—æŠ¥å‘Š</h1>
  <div id="reportContent"></div>
</div>

<script>
let roomCount = 0;
const gradeMap = { enf: 0.03, e0: 0.06, e1: 0.15 };
const cityData = {
  haerbin:   { T: 5.0,  RH: 63, n: 0.5 },
  beijing:   { T: 13.0, RH: 52, n: 0.5 },
  shanghai:  { T: 17.0, RH: 75, n: 0.5 },
  guangzhou: { T: 22.0, RH: 73, n: 0.5 },
  chengdu:   { T: 16.0, RH: 82, n: 0.5 },
  haikou:    { T: 24.0, RH: 84, n: 0.5 }
};

function toggleComplexityHelp() {
  const el = document.getElementById('complexityHelp');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function addRoom() {
  roomCount++;
  const id = `r${roomCount}`;
  const html = `
    <div class="room" id="${id}">
      <div>
        <label>æˆ¿é—´é•¿åº¦(L/m):</label><input type="number" value="4.0" step="0.1" min="1" data-f="L">
        <label>æˆ¿é—´å®½åº¦(W/m):</label><input type="number" value="3.5" step="0.1" min="1" data-f="W">
        <label>æˆ¿é—´é«˜åº¦(H/m):</label><input type="number" value="2.8" step="0.1" min="2" data-f="H">
        <button type="button" style="padding:2px 8px;font-size:12px;background:#f44336;color:white;border:none;border-radius:4px;" onclick="delRoom('${id}')">Ã—</button>
      </div>
      <div style="margin-top:10px;">
        <label>ç¯å¢ƒå‚æ•°:</label>
        <select data-f="city" onchange="toggleCustom(this,'${id}')">
          <option value="">è¯·é€‰æ‹©åŸå¸‚ï¼ˆè‡ªåŠ¨å¡«æ¸©æ¹¿åº¦ï¼‰</option>
          <option value="haerbin">å“ˆå°”æ»¨</option>
          <option value="beijing">åŒ—äº¬</option>
          <option value="shanghai">ä¸Šæµ·</option>
          <option value="guangzhou">å¹¿å·</option>
          <option value="chengdu">æˆéƒ½</option>
          <option value="haikou">æµ·å£</option>
          <option value="custom">è‡ªå®šä¹‰æ¸©æ¹¿åº¦ä¸æ¢æ°”æ¬¡æ•°</option>
        </select>
        <div id="cust${id}" style="display:none;margin-top:12px;padding:12px;background:#f0f7ff;border-radius:8px;">
          <label>æ¸©åº¦(â„ƒ):</label><input type="number" value="25" step="0.1" data-f="T">
          <label>æ¹¿åº¦(%):</label><input type="number" value="50" min="0" max="100" data-f="RH">
          <br><br>
          <label>æ¢æ°”æ¬¡æ•°(n):</label>
          <input type="number" value="0.5" step="0.1" min="0.1" max="3" data-f="n">
          <span style="font-size:12px;color:#666;margin-left:10px;">ï¼ˆæ™®é€šä½å®…å»ºè®®0.5ï¼‰</span>
        </div>
      </div>
      <div class="boards" id="bds${id}" style="margin-top:12px;">
        <div>
          <select data-f="g">
            <option value="enf">ENFçº§ï¼ˆâ‰¤0.03 mg/mÂ²Â·hï¼‰</option>
            <option value="e0">E0çº§ï¼ˆâ‰¤0.06 mg/mÂ²Â·hï¼‰</option>
            <option value="e1">E1çº§ï¼ˆâ‰¤0.15 mg/mÂ²Â·hï¼‰</option>
          </select>
          <input type="number" placeholder="æ¿æé¢ç§¯(mÂ²)" step="0.1" min="0" data-f="a">
        </div>
      </div>
      <button type="button" style="font-size:13px;padding:4px 8px;margin-top:8px;background:#e0e0e0;border:none;border-radius:4px;" onclick="addBoard('${id}')">â• æ·»åŠ æ›´å¤šæ¿æç±»å‹</button>
    </div>
  `;
  document.getElementById('rooms').insertAdjacentHTML('beforeend', html);
}

function delRoom(id) {
  document.getElementById(id).remove();
}

function toggleCustom(sel, id) {
  document.getElementById(`cust${id}`).style.display = sel.value === 'custom' ? 'block' : 'none';
}

function addBoard(id) {
  const c = document.getElementById(`bds${id}`);
  c.insertAdjacentHTML('beforeend', 
    `<div style="margin-top:8px;">
      <select data-f="g">
        <option value="enf">ENFçº§ï¼ˆâ‰¤0.03 mg/mÂ²Â·hï¼‰</option>
        <option value="e0">E0çº§ï¼ˆâ‰¤0.06 mg/mÂ²Â·hï¼‰</option>
        <option value="e1">E1çº§ï¼ˆâ‰¤0.15 mg/mÂ²Â·hï¼‰</option>
      </select>
      <input type="number" placeholder="é¢ç§¯(mÂ²)" step="0.1" min="0" data-f="a">
      <button type="button" style="padding:2px 8px;font-size:12px;background:#aaa;color:white;border:none;border-radius:4px;" onclick="this.parentElement.remove()">âˆ’</button>
    </div>`
  );
}

// ===== æ ¸å¿ƒï¼šæ¯æ¬¡è®¡ç®—å‰æ¸…ç©ºç»“æœåŒºåŸŸ =====
async function calculate() {
  document.getElementById('resultDisplay').innerHTML = '';
  document.getElementById('projectionSection').style.display = 'none';

  const rooms = document.querySelectorAll('.room');
  if (!rooms.length) { alert("è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªæˆ¿é—´"); return; }

  let totalUsed = 0, totalSafe = 0;
  let details = [], fullLogs = [];

  for (const r of rooms) {
    const L = parseFloat(r.querySelector('[data-f="L"]').value);
    const W = parseFloat(r.querySelector('[data-f="W"]').value);
    const H = parseFloat(r.querySelector('[data-f="H"]').value);
    if (!(L > 0 && W > 0 && H > 0)) { alert("æˆ¿é—´å°ºå¯¸å¿…é¡»å¤§äº0"); return; }
    const V = L * W * H;

    let T, RH, n, envSrc;
    const city = r.querySelector('[data-f="city"]').value;
    if (city && city !== 'custom') {
      ({T, RH, n} = cityData[city]);
      envSrc = city;
    } else {
      T = parseFloat(r.querySelector('[data-f="T"]').value);
      RH = parseFloat(r.querySelector('[data-f="RH"]').value);
      n = parseFloat(r.querySelector('[data-f="n"]').value);
      if (!(T >= -20 && T <= 50 && RH >= 0 && RH <= 100 && n > 0)) { 
        alert("è¯·æ£€æŸ¥è‡ªå®šä¹‰ç¯å¢ƒå‚æ•°æ˜¯å¦åˆç†"); 
        return; 
      }
      envSrc = "è‡ªå®šä¹‰";
    }

    const K = Math.exp(0.12 * (T - 23) + 0.015 * (RH - 50));
    
    const boards = Array.from(r.querySelectorAll('.boards > div'));
    let areaSum = 0, weightedE = 0, boardList = [];
    for (const b of boards) {
      const aStr = b.querySelector('[data-f="a"]').value;
      if (!aStr) continue;
      const a = parseFloat(aStr);
      if (a <= 0) continue;
      const g = b.querySelector('[data-f="g"]').value;
      const E0 = gradeMap[g];
      weightedE += a * E0 * K;
      areaSum += a;
      boardList.push({g, a, E0});
    }
    if (areaSum === 0) { alert("è¯·å¡«å†™è‡³å°‘ä¸€ç§æ¿æçš„é¢ç§¯"); return; }

    const E_avg = weightedE / areaSum;
    const S_max = (0.08 * n * V) / E_avg;

    totalUsed += areaSum;
    totalSafe += S_max;

    const isSafe = areaSum <= S_max;
    details.push({name:`æˆ¿é—´${r.id.slice(1)}`, used:areaSum, safe:S_max, isSafe});

    let log = `<h3>ã€æˆ¿é—´${r.id.slice(1)}ã€‘</h3>`;
    log += `<p>æˆ¿é—´å°ºå¯¸ï¼šé•¿ ${L} m Ã— å®½ ${W} m Ã— é«˜ ${H} m â†’ ä½“ç§¯ V = ${V.toFixed(2)} mÂ³</p>`;
    log += `<p>ç¯å¢ƒå‚æ•°æ¥æºï¼š${envSrc}ï¼ˆæ¸©åº¦ = ${T} â„ƒï¼Œæ¹¿åº¦ = ${RH} %ï¼Œæ¢æ°”æ¬¡æ•° n = ${n}ï¼‰</p>`;
    log += `<p>æ¸©æ¹¿åº¦ä¿®æ­£ç³»æ•° K = exp[0.12Ã—(${T}âˆ’23) + 0.015Ã—(${RH}âˆ’50)] = ${K.toFixed(4)}</p>`;
    log += `<p>æ‰€ç”¨äººé€ æ¿ç±»å‹åŠé¢ç§¯ï¼š</p><ul>`;
    boardList.forEach(b => {
      const name = b.g === 'enf' ? 'ENFçº§' : b.g === 'e0' ? 'E0çº§' : 'E1çº§';
      log += `<li>${name}ï¼š${b.a.toFixed(1)} mÂ²ï¼ˆæé™é‡Šæ”¾é‡ Eâ‚€ = ${b.E0} mg/mÂ²Â·hï¼‰</li>`;
    });
    log += `</ul>`;
    log += `<p>åŠ æƒå¹³å‡é‡Šæ”¾å¼ºåº¦ E_avg = ${E_avg.toFixed(4)} mg/mÂ²Â·h</p>`;
    log += `<p>æœ€å¤§å®‰å…¨ä½¿ç”¨é¢ç§¯ S_max = (0.08 Ã— ${n} Ã— ${V.toFixed(2)}) Ã· ${E_avg.toFixed(4)} = ${S_max.toFixed(2)} mÂ²</p>`;
    log += `<p>å½“å‰ä½¿ç”¨é¢ç§¯ï¼š${areaSum.toFixed(1)} mÂ² â†’ ${isSafe ? 'âœ… å®‰å…¨' : 'âš ï¸ è¶…é™'}</p>`;
    fullLogs.push(log);
  }

  const overallSafe = totalUsed <= totalSafe;
  const msg = overallSafe 
    ? `âœ… æ•´ä½“å®‰å…¨ï¼æ€»ä½¿ç”¨é¢ç§¯ ${totalUsed.toFixed(1)} mÂ² â‰¤ æœ€å¤§æ‰¿è½½é¢ç§¯ ${totalSafe.toFixed(1)} mÂ²`
    : `âš ï¸ æ•´ä½“è¶…é™ï¼è¶…å‡º ${(totalUsed - totalSafe).toFixed(1)} mÂ²`;

  document.getElementById('resultDisplay').innerHTML = 
    `<div class="result-box ${overallSafe?'safe':'unsafe'}">${msg}</div>`;

  window.calcResult = { details, fullLogs, totalUsed, totalSafe, overallSafe };
}

// ===== ä¿®æ­£åçš„æŠ•å½±å¯¹æ¯”åŠŸèƒ½ =====
function showProjection() {
  if (!window.calcResult) { alert("è¯·å…ˆç‚¹å‡»ã€è®¡ç®—æœ€å¤§å®‰å…¨ç”¨é‡ã€‘ï¼"); return; }
  
  document.getElementById('resultDisplay').innerHTML = '';
  let html = '<h3 style="margin:12px 0;color:#1a73e8;">è¯·è¾“å…¥å„æˆ¿é—´é”€å”®æä¾›çš„æŠ•å½±é¢ç§¯åŠå®¶å…·ç±»å‹</h3>';
  
  const typeOptionsTemplate = (roomId) => `
    <select id="type_${roomId}" onchange="updateFactor(this)">
      <option value="cabinet">è¡£æŸœ/ä¹¦æŸœï¼ˆç³»æ•°â‰ˆ3.5ï¼‰</option>
      <option value="lowcabinet">ç”µè§†æŸœ/çŸ®æŸœï¼ˆç³»æ•°â‰ˆ3.0ï¼‰</option>
      <option value="floor">åœ°æ¿ï¼ˆç³»æ•°=1.0ï¼‰</option>
      <option value="wall">å¢™æ¿/åŠé¡¶ï¼ˆç³»æ•°â‰ˆ1.1ï¼‰</option>
      <option value="custom">è‡ªå®šä¹‰ç³»æ•°</option>
    </select>
    <input type="number" id="factor_${roomId}" placeholder="ç³»æ•°" step="0.1" min="0.5" max="6" style="width:80px;display:none;" value="3.5">
    <span style="font-size:12px;color:#666;margin-left:6px;">â†’ é‡Šæ”¾é¢ç§¯ â‰ˆ æŠ•å½±é¢ç§¯ Ã— ç³»æ•°</span>
  `;
  
  html += window.calcResult.details.map(d => {
    const roomId = d.name.replace(/\s+/g, '_');
    return `
      <div class="projection-item">
        <strong>${d.name}</strong><br>
        <label>æŠ•å½±é¢ç§¯(mÂ²):</label>
        <input type="number" id="p_${roomId}" placeholder="å¦‚ï¼š4.5" step="0.1" style="width:100px;">
        ${typeOptionsTemplate(roomId)}
      </div>
    `;
  }).join('');
  
  html += `<button onclick="doCompare()" style="margin-top:12px;background:#ff9800;color:white;padding:8px 16px;border:none;border-radius:6px;font-weight:bold;">ğŸ” æ¢ç®—åå¯¹æ¯”å®‰å…¨æ€§</button>`;
  document.getElementById('projectionSection').innerHTML = html;
  document.getElementById('projectionSection').style.display = 'block';
}

function updateFactor(sel) {
  const roomId = sel.id.replace('type_', '');
  const factorInput = document.getElementById(`factor_${roomId}`);
  if (sel.value === 'custom') {
    factorInput.style.display = 'inline';
  } else {
    factorInput.style.display = 'none';
    factorInput.value = sel.value === 'cabinet' ? 3.5 :
                        sel.value === 'lowcabinet' ? 3.0 :
                        sel.value === 'floor' ? 1.0 : 1.1;
  }
}

function doCompare() {
  if (!window.calcResult) return;
  
  const res = window.calcResult;
  let allSafe = true, logs = [];
  let totalProj = 0, totalEstRelease = 0;

  for (const d of res.details) {
    const roomId = d.name.replace(/\s+/g, '_');
    const projInput = parseFloat(document.getElementById(`p_${roomId}`).value);
    const factorInput = document.getElementById(`factor_${roomId}`);
    let factor = parseFloat(factorInput.value);

    if (isNaN(projInput) || projInput < 0) { 
      alert(`è¯·å¡«å†™ ${d.name} çš„æŠ•å½±é¢ç§¯`); 
      return; 
    }
    if (isNaN(factor) || factor <= 0) {
      alert(`è¯·å¡«å†™ ${d.name} çš„æœ‰æ•ˆæ¢ç®—ç³»æ•°`);
      return;
    }

    const estRelease = projInput * factor;
    totalProj += projInput;
    totalEstRelease += estRelease;
    
    const safe = estRelease <= d.safe;
    if (!safe) allSafe = false;
    logs.push(`${d.name}: æŠ•å½± ${projInput.toFixed(1)} mÂ² Ã— ${factor.toFixed(1)} â‰ˆ é‡Šæ”¾ ${estRelease.toFixed(1)} mÂ² vs å®‰å…¨ä¸Šé™ ${d.safe.toFixed(1)} mÂ² â†’ ${safe ? 'å®‰å…¨' : 'è¶…é™'}`);
  }

  // æ„å»ºç»“æœï¼šå…ˆæ˜¾ç¤ºåŸå§‹è®¡ç®—ç»“è®ºï¼Œå†åŠ å¯¹æ¯”
  let output = `<div class="result-box ${res.overallSafe?'safe':'unsafe'}">
    ${res.overallSafe 
      ? `âœ… æ•´ä½“å®‰å…¨ï¼æ€»ä½¿ç”¨é¢ç§¯ ${res.totalUsed.toFixed(1)} mÂ² â‰¤ æœ€å¤§æ‰¿è½½é¢ç§¯ ${res.totalSafe.toFixed(1)} mÂ²`
      : `âš ï¸ æ•´ä½“è¶…é™ï¼è¶…å‡º ${(res.totalUsed - res.totalSafe).toFixed(1)} mÂ²`}
  </div>`;

  const conclusion = allSafe 
    ? `âœ… æ‰€æœ‰æˆ¿é—´ä¼°ç®—é‡Šæ”¾é¢ç§¯å‡åœ¨å®‰å…¨èŒƒå›´å†…ï¼ˆæ€»æŠ•å½± ${totalProj.toFixed(1)} mÂ² â†’ ä¼°ç®—é‡Šæ”¾ ${totalEstRelease.toFixed(1)} mÂ²ï¼‰`
    : `âŒ å­˜åœ¨è¶…é™æˆ¿é—´ï¼è¯·å‡å°‘ç”¨é‡æˆ–é€‰æ‹©æ›´ç¯ä¿æ¿æ`;
    
  output += `<div class="result-box ${allSafe?'safe':'unsafe'}" style="margin-top:12px;">${conclusion}</div>`;

  document.getElementById('resultDisplay').innerHTML = output;
  window.projectionLogs = logs;
}

function sharePage() {
  const url = location.href;
  if (navigator.share) {
    navigator.share({ title: 'GB/T 39598-2021 ç”²é†›æ‰¿è½½é™é‡è®¡ç®—å™¨', url });
  } else {
    navigator.clipboard?.writeText(url).then(() => {
      alert("é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç²˜è´´åˆ°å¾®ä¿¡åˆ†äº«");
    }).catch(() => {
      alert("æ— æ³•å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨åˆ†äº«æ­¤é¡µé¢é“¾æ¥");
    });
  }
}

async function exportToPDF() {
  if (!window.calcResult) { alert("è¯·å…ˆå®Œæˆè®¡ç®—ï¼"); return; }

  let report = `<h2>ä¸€ã€è®¡ç®—ä¾æ®</h2>
    <p>æ ‡å‡†ï¼šã€ŠGB/T 39598-2021 åŸºäºæé™ç”²é†›é‡Šæ”¾é‡çš„äººé€ æ¿å®¤å†…æ‰¿è½½é™é‡æŒ‡å—ã€‹</p>
    <p>æ ¸å¿ƒå…¬å¼ï¼š<br>
      S_max = (C Ã— n Ã— V) / (Eâ‚€ Ã— K)<br>
      å…¶ä¸­ C = 0.08 mg/mÂ³ï¼ˆå®¤å†…ç”²é†›æµ“åº¦é™å€¼ï¼‰</p>
    <p>æ¸©æ¹¿åº¦ä¿®æ­£ç³»æ•°ï¼š<br>
      K = exp[0.12Ã—(Tâˆ’23) + 0.015Ã—(RHâˆ’50)]</p>
    <p>æ¿ææé™é‡Šæ”¾é‡ Eâ‚€ï¼š<br>
      ENFçº§ â‰¤ 0.03 mg/mÂ²Â·hï¼ŒE0çº§ â‰¤ 0.06 mg/mÂ²Â·hï¼ŒE1çº§ â‰¤ 0.15 mg/mÂ²Â·h</p>

    <h2>äºŒã€è¯¦ç»†è®¡ç®—ç»“æœ</h2>`;

  report += window.calcResult.fullLogs.join('');

  if (window.projectionLogs) {
    report += `<h2>ä¸‰ã€é”€å”®æŠ•å½±é¢ç§¯å¯¹æ¯”ç»“æœ</h2><ul>`;
    window.projectionLogs.forEach(l => report += `<li>${l}</li>`);
    report += `</ul>`;
  }

  report += `<h2>å››ã€é‡è¦è¯´æ˜</h2>
    <p>â€¢ é‡Šæ”¾è¡¨é¢ç§¯ â‰  æŠ•å½±é¢ç§¯ï¼æœ¬å·¥å…·é€šè¿‡å®¶å…·ç±»å‹ç³»æ•°å°†æŠ•å½±é¢ç§¯æ¢ç®—ä¸ºä¼°ç®—é‡Šæ”¾é¢ç§¯ã€‚</p>
    <p>â€¢ è¡£æŸœ/ä¹¦æŸœç³»æ•° â‰ˆ 3.5ï¼Œç”µè§†æŸœ â‰ˆ 3.0ï¼Œåœ°æ¿ = 1.0ï¼Œå¢™æ¿ â‰ˆ 1.1ï¼ˆç»éªŒå€¼ï¼‰</p>
    <p>â€¢ å®é™…é‡Šæ”¾é¢ç§¯å¯èƒ½å› ç»“æ„å·®å¼‚è€Œä¸åŒï¼Œå»ºè®®ç•™æœ‰ä½™é‡ã€‚</p>
    <p style="margin-top:20px;font-size:12px;color:#888;">æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>`;

  document.getElementById('reportContent').innerHTML = report;
  document.getElementById('fullReport').style.display = 'block';

  const { jsPDF } = window.jspdf;
  const el = document.getElementById('fullReport');
  const canvas = await html2canvas(el, { scale: 2, useCORS: true, logging: false });
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageWidth = 210;
  const imgHeight = (canvas.height * pageWidth) / canvas.width;
  let heightLeft = imgHeight;
  let position = 0;

  pdf.addImage(img, 'PNG', 0, position, pageWidth, imgHeight);
  heightLeft -= 297;

  while (heightLeft > 0) {
    pdf.addPage();
    position = heightLeft - imgHeight;
    pdf.addImage(img, 'PNG', 0, position, pageWidth, imgHeight);
    heightLeft -= 297;
  }

  pdf.save('GB_T_39598-2021_ç”²é†›æ‰¿è½½é™é‡è®¡ç®—æŠ¥å‘Š.pdf');
  document.getElementById('fullReport').style.display = 'none';
}

// åˆå§‹åŒ–
addRoom();
</script>

</body>

</html>
